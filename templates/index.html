<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRISMA - Sistema de Análisis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
        
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Roboto Condensed', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        }
        
        .header {
            background: linear-gradient(to right, #1a1a1a, #2a2a2a);
            border-bottom: 2px solid #c0c0c0;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #c0c0c0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }
        
        .header h2 {
            color: #c0c0c0;
            font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }
        
        .container {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid #c0c0c0;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .drag-area {
            border: 2px dashed #c0c0c0;
            transition: all 0.3s ease;
            background-color: rgba(192, 192, 192, 0.05);
        }
        
        .drag-area.active {
            border-color: #c0c0c0;
            background-color: rgba(192, 192, 192, 0.1);
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.2);
        }
        
        .preview-container {
            max-height: 800px;
            overflow-y: auto;
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        
        .pdf-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
            position: relative;
        }
        
        .pdf-preview-section {
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            border-radius: 4px;
            padding: 1rem;
        }
        
        .pdf-data-section {
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            border-radius: 4px;
            padding: 1rem;
            position: relative;
        }
        
        .data-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #c0c0c0;
        }
        
        .data-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .data-label {
            color: #c0c0c0;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .data-value {
            color: #e0e0e0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .data-verification {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .verification-btn {
            background-color: #2a2a2a;
            color: #c0c0c0;
            border: 1px solid #c0c0c0;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .verification-btn:hover {
            background-color: #c0c0c0;
            color: #1a1a1a;
        }
        
        .verification-status {
            margin-left: 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
        }
        
        .verification-status i {
            margin-right: 0.5rem;
        }
        
        .verification-status.verified {
            color: #00ff00;
        }
        
        .verification-status.unverified {
            color: #ff0000;
        }
        
        .verification-status.auto-verified {
            color: #00ff00;
        }
        
        .financial-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .financial-card {
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            border-radius: 4px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .financial-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .financial-card h3 {
            color: #c0c0c0;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .financial-card p {
            color: #e0e0e0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .tab-btn {
            color: #c0c0c0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }
        
        .tab-btn:hover {
            color: #e0e0e0;
        }
        
        .tab-btn.active {
            border-bottom-color: #c0c0c0;
            color: #e0e0e0;
        }
        
        .loading-spinner {
            border: 3px solid #2a2a2a;
            border-top: 3px solid #c0c0c0;
        }
        
        .section-title {
            color: #c0c0c0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #c0c0c0;
        }
        
        .btn {
            background-color: #2a2a2a;
            color: #c0c0c0;
            border: 1px solid #c0c0c0;
            padding: 0.5rem 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background-color: #c0c0c0;
            color: #1a1a1a;
        }
        
        .input-field {
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            color: #e0e0e0;
            padding: 0.5rem;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #c0c0c0;
            box-shadow: 0 0 0 2px rgba(192, 192, 192, 0.2);
        }

        .pdf-item {
            background-color: #2a2a2a;
            border: 1px solid #c0c0c0;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .pdf-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #c0c0c0;
        }

        .pdf-item-title {
            color: #c0c0c0;
            font-size: 0.9rem;
            font-weight: bold;
            word-break: break-all;
            max-width: 80%;
        }

        .pdf-item-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .pdf-item-status.processing {
            background-color: rgba(192, 192, 192, 0.2);
            color: #c0c0c0;
        }

        .pdf-item-status.completed {
            background-color: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .pdf-item-status.error {
            background-color: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            width: 100%;
            height: 100%;
            background-color: #2a2a2a;
            padding: 1rem;
            border-radius: 4px;
            position: relative;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 1rem;
        }

        .modal-pdf-container {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }

        .modal-data-container {
            background: rgba(42, 42, 42, 0.95);
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #c0c0c0;
            overflow-y: auto;
            max-height: 100%;
        }

        .modal-data-title {
            color: #c0c0c0;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #c0c0c0;
            position: sticky;
            top: 0;
            background: rgba(42, 42, 42, 0.95);
            z-index: 10;
        }

        .modal-data-item {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(26, 26, 26, 0.5);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .modal-data-item:hover {
            background: rgba(26, 26, 26, 0.8);
        }

        .modal-data-label {
            color: #c0c0c0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .modal-data-value {
            color: #e0e0e0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #c0c0c0;
            cursor: pointer;
            font-size: 2rem;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: #e0e0e0;
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Estilos para el popup de análisis de IA */
        .analysis-popup {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            backdrop-filter: blur(4px);
        }

        .analysis-popup-content {
            text-align: center;
            color: #e0e0e0;
        }

        .analysis-popup h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #c0c0c0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .analysis-popup p {
            font-size: 1rem;
            color: #a0a0a0;
            margin-bottom: 2rem;
        }

        .ai-animation {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #c0c0c0;
            animation: spin 1s linear infinite, pulse 2s ease-in-out infinite;
            position: relative;
        }

        .ai-animation::before, .ai-animation::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .ai-animation::before {
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 3px solid transparent;
            border-right-color: #9f9f9f;
            animation: spin 1.5s linear infinite reverse;
        }

        .ai-animation::after {
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 3px solid transparent;
            border-bottom-color: #7f7f7f;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Estilos para el mensaje de error (carpeta cerrada) */
        .error-folder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            backdrop-filter: blur(5px);
        }

        .folder-icon {
            font-size: 4rem;
            color: #c0c0c0;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .error-stamp {
            transform: rotate(-15deg);
            border: 4px solid #ff0000;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            position: relative;
            background-color: rgba(255, 0, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }

        .error-stamp h3 {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff0000;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0;
            text-align: center;
        }

        .error-message {
            font-size: 1rem;
            color: #a0a0a0;
            text-align: center;
            max-width: 80%;
        }
        
        .pdf-external-link {
            background-color: rgba(59, 130, 246, 0.2);
            color: rgb(96, 165, 250);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .pdf-external-link:hover {
            background-color: rgba(59, 130, 246, 0.3);
            color: rgb(147, 197, 253);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .pdf-external-link[target="_blank"] {
            background-color: rgba(45, 55, 72, 0.3);
            color: rgb(156, 163, 175);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        
        .pdf-external-link[target="_blank"]:hover {
            background-color: rgba(45, 55, 72, 0.5);
            color: rgb(209, 213, 219);
        }
        
        .flex.flex-col.gap-2 {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="header">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">PRISMA</h1>
            <h2 class="text-center">Procesamiento de Recursos de Información Sistemática Mediante Algoritmos</h2>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-black/50 backdrop-blur-sm rounded-lg shadow-lg p-6">
            <!-- Tabs -->
            <div class="flex mb-6 border-b border-[#c0c0c0]">
                <button class="tab-btn px-4 py-2 active" data-tab="file">
                    <i class="fas fa-file-upload mr-2"></i>Cargar Archivos
                </button>
                <button class="tab-btn px-4 py-2" data-tab="url">
                    <i class="fas fa-link mr-2"></i>URL
                </button>
            </div>

            <!-- File Upload Tab -->
            <div class="tab-content" id="file-tab">
                <div class="drag-area p-8 text-center rounded-lg cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-4xl text-[#c0c0c0] mb-4"></i>
                    <p class="text-[#c0c0c0]">Arrastra y suelta los archivos PDF aquí</p>
                    <p class="text-sm text-[#c0c0c0]/70 mt-2">O</p>
                    <input type="file" id="file-input" class="hidden" accept=".pdf" multiple>
                    <button class="btn mt-4">
                        Seleccionar Archivos
                    </button>
                </div>
            </div>

            <!-- URL Tab -->
            <div class="tab-content hidden" id="url-tab">
                <div class="flex gap-4">
                    <input type="url" id="url-input" class="input-field flex-1 rounded-lg" 
                           placeholder="Ingresa la URL del PDF">
                    <button id="url-submit" class="btn">
                        Procesar
                    </button>
                </div>
            </div>

            <!-- PDF Items Container -->
            <div id="pdf-items" class="mt-6">
                <!-- Los PDFs procesados se mostrarán aquí -->
            </div>

            <div class="input-group mb-3">
                <span class="input-group-text" id="inputGroup-sizing-default">Tipo de Documento</span>
                <select class="form-select" id="document-type" disabled>
                    <option value="ENDOSO_A">Endoso Tipo A</option>
                    <option value="POLIZA_VIDA">Póliza de Vida</option>
                    <option value="POLIZA_VIDA_INDIVIDUAL">Póliza de Vida Individual</option>
                    <option value="POLIZA_ALIADOS_PPR">Póliza Aliados+ PPR</option>
                    <option value="POLIZA_PROTGT_TEMPORAL_MN">Póliza PROTGT Temporal MN</option>
                    <option value="POLIZA_VIDA_PROTGT">Póliza VIDA PROTGT</option>
                    <option value="PROTECCION_EFECTIVA">Póliza Protección Efectiva</option>
                    <option value="PROTGT_PYME">Plan Protege PYME</option>
                    <option value="SALUD_FAMILIAR">Póliza de Gastos Médicos Familiar</option>
                    <option value="DESCONOCIDO">Desconocido</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa en grande -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-pdf-container">
                <embed id="modal-preview" type="application/pdf" width="100%" height="100%">
            </div>
            <div class="modal-data-container">
                <h3 class="modal-data-title">Datos Verificados</h3>
                <div class="modal-data-item">
                    <div class="modal-data-label">Gastos por Expedición</div>
                    <div class="modal-data-value" data-field="gastos">$0.00</div>
                </div>
                <div class="modal-data-item">
                    <div class="modal-data-label">IVA</div>
                    <div class="modal-data-value" data-field="iva">$0.00</div>
                </div>
                <div class="modal-data-item">
                    <div class="modal-data-label">Precio Total</div>
                    <div class="modal-data-value" data-field="total">$0.00</div>
                </div>
                <div class="modal-data-item">
                    <div class="modal-data-label">Prima Neta</div>
                    <div class="modal-data-value" data-field="prima">$0.00</div>
                </div>
                <div class="modal-data-item">
                    <div class="modal-data-label">Tasa de Financiamiento</div>
                    <div class="modal-data-value" data-field="tasa">0.00%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${tab}-tab`) {
                        content.classList.remove('hidden');
                    }
                });
            });
        });

        // File upload handling
        const dragArea = document.querySelector('.drag-area');
        const fileInput = document.getElementById('file-input');
        const pdfItems = document.getElementById('pdf-items');
        const modal = document.getElementById('preview-modal');
        const modalPreview = document.getElementById('modal-preview');
        const modalClose = document.querySelector('.modal-close');

        dragArea.addEventListener('click', () => fileInput.click());

        dragArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragArea.classList.add('active');
        });

        dragArea.addEventListener('dragleave', () => {
            dragArea.classList.remove('active');
        });

        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files).filter(file => file.type === 'application/pdf');
            handleFiles(files);
        });

        // URL handling
        document.getElementById('url-submit').addEventListener('click', () => {
            const url = document.getElementById('url-input').value;
            if (url) {
                handleUrlUpload(url);
            }
        });

        function createPdfItem(fileName) {
            const item = document.createElement('div');
            item.className = 'pdf-item';
            item.innerHTML = `
                <div class="pdf-item-header">
                    <span class="pdf-item-title">${fileName}</span>
                    <span class="pdf-item-status processing">Procesando...</span>
                </div>
                <div class="pdf-content">
                    <div class="pdf-preview-section">
                        <h3 class="section-title">VISTA PREVIA DEL DOCUMENTO</h3>
                        <div class="document-info bg-gray-800 p-4 mb-4 rounded-lg">
                            <div class="info-item mb-2">
                                <span class="text-gray-400">Ramo:</span>
                                <span class="text-white ml-2 document-ramo">-</span>
                            </div>
                            <div class="info-item">
                                <span class="text-gray-400">Tipo de Documento:</span>
                                <span class="text-white ml-2 document-tipo-endoso">-</span>
                            </div>
                        </div>
                        <div class="preview-container p-4 rounded-lg relative">
                            <div class="analysis-popup">
                                <div class="analysis-popup-content">
                                    <div class="ai-animation"></div>
                                    <h3>Analizando con IA RINO</h3>
                                    <p>Procesando documento y extrayendo datos...</p>
                                </div>
                            </div>
                            <img class="mx-auto cursor-pointer" alt="Vista Previa del PDF">
                        </div>
                    </div>
                    <div class="pdf-data-section">
                        <h3 class="section-title">Datos Financieros</h3>
                        <div class="analysis-popup">
                            <div class="analysis-popup-content">
                                <div class="ai-animation"></div>
                                <h3>Analizando con IA RINO</h3>
                                <p>Extrayendo datos financieros...</p>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Gastos por Expedición</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">IVA</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Precio Total</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Prima Neta</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Tasa de Financiamiento</div>
                            <div class="data-value">0.00%</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <!-- Campos financieros para pólizas de salud familiar -->
                        <div class="data-item">
                            <div class="data-label">Descuento familiar</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Cesión de Comisión</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Recargo por pago fraccionado</div>
                            <div class="data-value">$0.00</div>
                            <div class="data-verification">
                                <span class="verification-status unverified">
                                    <i class="fas fa-times-circle"></i>Sin verificar
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return item;
        }

        function handleFiles(files) {
            files.forEach(file => {
                const pdfItem = createPdfItem(file.name);
                pdfItems.appendChild(pdfItem);
                processFile(file, pdfItem);
            });
        }

        async function handleUrlUpload(url) {
            const formData = new FormData();
            formData.append('url', url);
            const pdfItem = createPdfItem('PDF desde URL');
            pdfItems.appendChild(pdfItem);
            await processUpload(formData, pdfItem);
        }

        async function processFile(file, pdfItem) {
            const formData = new FormData();
            formData.append('file', file);
            await processUpload(formData, pdfItem);
        }

        async function processUpload(formData, pdfItem) {
            const statusElement = pdfItem.querySelector('.pdf-item-status');
            const previewElement = pdfItem.querySelector('img');
            const ramoElement = pdfItem.querySelector('.document-ramo');
            const tipoEndosoElement = pdfItem.querySelector('.document-tipo-endoso');
            const analysisPopup = pdfItem.querySelector('.analysis-popup');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    console.log("Respuesta de servidor:", data);
                    
                    if (data.preview) {
                        previewElement.setAttribute('data-pdf', data.pdf_data);
                        previewElement.src = `data:image/png;base64,${data.preview}`;
                    }
                    
                    if (data.financial_data) {
                        console.log("Datos financieros recibidos:", data.financial_data);
                        console.log("Tipo de documento:", data.document_type);
                        
                        if (data.document_type === "POLIZA_VIDA" && data.poliza_data) {
                            console.log("Datos de póliza recibidos:", data.poliza_data);
                            console.log("Prima Neta recibida:", data.poliza_data["Prima Neta"]);
                            console.log("Prima anual total recibida:", data.poliza_data["Prima anual total"]);
                            
                            // Guardar los datos de la póliza en el elemento pdfItem
                            pdfItem.setAttribute('data-poliza-data', JSON.stringify(data.poliza_data));
                            
                            // Mostrar todos los datos de la póliza en lugar de los financieros
                            displayPolizaVidaData(data.poliza_data, pdfItem, true);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = "VIDA";
                            if (tipoEndosoElement) tipoEndosoElement.textContent = "PÓLIZA DE VIDA";
                        } else if (data.document_type === "POLIZA_ALIADOS_PPR" && data.poliza_data) {
                            console.log("Datos de póliza Aliados+ PPR recibidos:", data.poliza_data);
                            console.log("Prima Neta recibida:", data.poliza_data["Prima Neta"]);
                            console.log("Prima anual total recibida:", data.poliza_data["Prima anual total"]);
                            
                            // Guardar los datos de la póliza en el elemento pdfItem
                            pdfItem.setAttribute('data-poliza-data', JSON.stringify(data.poliza_data));
                            
                            // Mostrar todos los datos de la póliza en lugar de los financieros
                            displayPolizaVidaData(data.poliza_data, pdfItem, true);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = "VIDA";
                            if (tipoEndosoElement) tipoEndosoElement.textContent = data.description || "PÓLIZA ALIADOS+ PPR";
                        } else if (data.document_type === "POLIZA_PROTGT_TEMPORAL_MN" && data.poliza_data) {
                            console.log("Datos de póliza Protegete Temporal MN recibidos:", data.poliza_data);
                            console.log("Prima Neta recibida:", data.poliza_data["Prima Neta"]);
                            console.log("Prima anual total recibida:", data.poliza_data["Prima anual total"]);
                            
                            // Guardar los datos de la póliza en el elemento pdfItem
                            pdfItem.setAttribute('data-poliza-data', JSON.stringify(data.poliza_data));
                            
                            // Mostrar todos los datos de la póliza en lugar de los financieros
                            displayPolizaVidaData(data.poliza_data, pdfItem, true);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = "VIDA";
                            if (tipoEndosoElement) tipoEndosoElement.textContent = data.description || "PÓLIZA PROTGT TEMPORAL MN";
                        } else if (data.document_type === "POLIZA_VIDA_PROTGT" && data.poliza_data) {
                            console.log("Datos de póliza VIDA PROTGT recibidos:", data.poliza_data);
                            console.log("Prima Neta recibida:", data.poliza_data["Prima Neta"]);
                            console.log("Prima anual total recibida:", data.poliza_data["Prima anual total"]);
                            
                            // Guardar los datos de la póliza en el elemento pdfItem
                            pdfItem.setAttribute('data-poliza-data', JSON.stringify(data.poliza_data));
                            
                            // Mostrar todos los datos de la póliza en lugar de los financieros
                            displayPolizaVidaData(data.poliza_data, pdfItem, true);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = "VIDA";
                            if (tipoEndosoElement) tipoEndosoElement.textContent = data.description || "PÓLIZA VIDA PROTGT";
                        } else if (data.document_type === "SALUD_FAMILIAR" && data.poliza_data) {
                            console.log("Datos de póliza de Gastos Médicos Mayores Familiar recibidos:", data.poliza_data);
                            console.log("Prima Neta recibida:", data.poliza_data["Prima Neta"]);
                            console.log("Prima anual total recibida:", data.poliza_data["Prima anual total"]);
                            console.log("Descuento familiar recibido:", data.poliza_data["Descuento familiar"]);
                            console.log("Cesión de Comisión recibida:", data.poliza_data["Cesión de Comisión"]);
                            console.log("Recargo por pago fraccionado recibido:", data.poliza_data["Recargo por pago fraccionado"]);
                            
                            // Guardar los datos de la póliza en el elemento pdfItem
                            pdfItem.setAttribute('data-poliza-data', JSON.stringify(data.poliza_data));
                            
                            // Mostrar todos los datos de la póliza en lugar de los financieros
                            displayPolizaVidaData(data.poliza_data, pdfItem, true);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = "SALUD";
                            if (tipoEndosoElement) tipoEndosoElement.textContent = data.description || "PÓLIZA DE GASTOS MÉDICOS MAYORES FAMILIAR";
                        } else {
                            // Para endosos tipo A, mostrar datos financieros normalmente
                            displayFinancialData(data.financial_data, pdfItem);
                            previewElement.setAttribute('data-financial', JSON.stringify(data.financial_data));
                            
                            // Actualizar información del documento
                            if (ramoElement) ramoElement.textContent = data.financial_data.ramo || 'AUTOS';
                            if (tipoEndosoElement) tipoEndosoElement.textContent = data.financial_data.tipo_endoso || 'A - MODIFICACIÓN DE DATOS';
                        }
                    }
                    
                    // Ocultar el popup de análisis
                    if (analysisPopup) {
                        analysisPopup.style.display = 'none';
                    }
                    
                    statusElement.textContent = 'Completado';
                    statusElement.className = 'pdf-item-status completed';
                } else {
                    // Ocultar el popup de análisis en caso de error
                    if (analysisPopup) {
                        analysisPopup.style.display = 'none';
                    }
                    
                    // Mostrar el mensaje de carpeta cerrada
                    showErrorFolder(pdfItem);
                    
                    statusElement.textContent = 'Error';
                    statusElement.className = 'pdf-item-status error';
                    
                    // No mostrar alert para no interrumpir la experiencia
                    console.error(data.error || 'Error al procesar el documento');
                }
            } catch (error) {
                // Ocultar el popup de análisis en caso de error
                if (analysisPopup) {
                    analysisPopup.style.display = 'none';
                }
                
                // Mostrar el mensaje de carpeta cerrada
                showErrorFolder(pdfItem);
                
                statusElement.textContent = 'Error';
                statusElement.className = 'pdf-item-status error';
                
                // No mostrar alert para no interrumpir la experiencia
                console.error('Error al procesar el documento:', error.message);
            }
        }

        function showErrorFolder(pdfItem) {
            // Crear elementos de error para la vista previa y para los datos financieros
            const previewSection = pdfItem.querySelector('.pdf-preview-section');
            const dataSection = pdfItem.querySelector('.pdf-data-section');
            
            // Obtener el nombre del archivo para construir la URL
            const fileName = pdfItem.querySelector('.pdf-item-title').textContent;
            // Asegurar que la URL esté formateada correctamente sin barras duplicadas
            const pdfUrl = `https://robotsrino.com/files/endosos/AUTOS/AUMENTO/CAMBIO_FORMA_PAGO/${encodeURIComponent(fileName)}`;
            
            console.log('URL construida para el documento:', pdfUrl);
            
            // Verificar qué tipo de documento estamos procesando
            const tipoEndosoElement = pdfItem.querySelector('.document-tipo-endoso');
            const isPolizaVida = tipoEndosoElement && 
                                (tipoEndosoElement.textContent === "PÓLIZA DE VIDA" || 
                                 tipoEndosoElement.textContent === "PÓLIZA ALIADOS+ PPR" ||
                                 tipoEndosoElement.textContent === "PÓLIZA PROTGT TEMPORAL MN" ||
                                 tipoEndosoElement.textContent === "PÓLIZA VIDA PROTGT");
            
            // Configurar los mensajes según el tipo de documento
            const titleMessage = isPolizaVida ? "No se pudo procesar la póliza" : "Esto no es un endoso de tipo A";
            const errorMessage = isPolizaVida 
                ? "Este documento no pudo ser procesado correctamente como póliza de vida." 
                : "Este documento no puede ser procesado como un endoso de tipo A.";
            const dataErrorMessage = isPolizaVida
                ? "No se pudieron extraer los datos de la póliza de vida."
                : "No se pueden extraer datos financieros de este documento.";
            
            if (previewSection) {
                const previewContainer = previewSection.querySelector('.preview-container');
                
                // Eliminar popup de análisis si existe
                const existingAnalysisPopup = previewContainer.querySelector('.analysis-popup');
                if (existingAnalysisPopup) {
                    existingAnalysisPopup.remove();
                }
                
                // Crear el elemento de error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-folder';
                errorDiv.innerHTML = `
                    <i class="fas fa-folder folder-icon"></i>
                    <div class="error-stamp">
                        <h3>${titleMessage}</h3>
                    </div>
                    <p class="error-message">${errorMessage}</p>
                    <div class="flex flex-col gap-2 mt-4">
                        <a href="#" class="pdf-external-link" data-url="${pdfUrl}">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Ver en visor
                        </a>
                        <a href="${pdfUrl}" class="pdf-external-link" target="_blank" rel="noopener noreferrer">
                            <i class="fas fa-file-pdf mr-2"></i>
                            Abrir en nueva pestaña
                        </a>
                    </div>
                `;
                
                previewContainer.appendChild(errorDiv);
                
                // Agregar evento al enlace
                const externalLink = errorDiv.querySelector('.pdf-external-link');
                if (externalLink) {
                    externalLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openPdfInPopup(pdfUrl, fileName);
                    });
                }
            }
            
            if (dataSection) {
                // Eliminar popup de análisis si existe
                const existingAnalysisPopup = dataSection.querySelector('.analysis-popup');
                if (existingAnalysisPopup) {
                    existingAnalysisPopup.remove();
                }
                
                // Limpiar contenido actual
                dataSection.innerHTML = '<h3 class="section-title">Datos Financieros</h3>';
                
                // Crear el elemento de error
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-folder';
                errorDiv.innerHTML = `
                    <i class="fas fa-folder folder-icon"></i>
                    <div class="error-stamp">
                        <h3>${titleMessage}</h3>
                    </div>
                    <p class="error-message">${dataErrorMessage}</p>
                    <div class="flex flex-col gap-2 mt-4">
                        <a href="#" class="pdf-external-link" data-url="${pdfUrl}">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Ver en visor
                        </a>
                        <a href="${pdfUrl}" class="pdf-external-link" target="_blank" rel="noopener noreferrer">
                            <i class="fas fa-file-pdf mr-2"></i>
                            Abrir en nueva pestaña
                        </a>
                    </div>
                `;
                
                dataSection.appendChild(errorDiv);
                
                // Agregar evento al enlace
                const externalLink = errorDiv.querySelector('.pdf-external-link');
                if (externalLink) {
                    externalLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openPdfInPopup(pdfUrl, fileName);
                    });
                }
            }
        }

        // Función para abrir PDF en popup
        function openPdfInPopup(pdfUrl, fileName) {
            const modal = document.getElementById('preview-modal');
            const modalPreview = document.getElementById('modal-preview');
            
            // Asegurar que la URL tenga el prefijo https://
            if (!pdfUrl.startsWith('http')) {
                console.warn('URL no comienza con http, añadiendo protocolo https://');
                pdfUrl = 'https://' + pdfUrl.replace(/^\/+/, '');
            }
            
            console.log('Abriendo PDF desde URL:', pdfUrl);
            
            // Asignar la URL al visor de PDF
            modalPreview.src = pdfUrl;
            modalPreview.type = 'application/pdf';
            
            // Actualizar título del modal
            const modalTitle = document.querySelector('.modal-data-title');
            if (modalTitle) {
                modalTitle.textContent = fileName;
            }
            
            // Mostrar mensaje de vista externa
            const modalData = document.querySelector('.modal-data-container');
            if (modalData) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'modal-data-item mt-4';
                infoDiv.innerHTML = `
                    <div class="modal-data-label">Documento externo</div>
                    <div class="modal-data-value">
                        <span class="text-yellow-400">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Este documento se está cargando desde una fuente externa.
                        </span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        URL: ${pdfUrl}
                    </div>
                `;
                
                // Limpiar contenedor de datos financieros
                modalData.innerHTML = '';
                modalData.appendChild(infoDiv);
            }
            
            modal.style.display = 'flex';
        }

        function displayFinancialData(data, container) {
            // Encontrar el contenedor específico dentro del pdfItem
            const financialDataDiv = container.querySelector('.pdf-data-section'); 
            if (!financialDataDiv) {
                console.error("No se encontró .pdf-data-section dentro del container", container);
                return; // Salir si no se encuentra el contenedor
            }
            
            // NO limpiamos completamente el contenedor para preservar la estructura existente
            // Obtener el título y mantenerlo
            const sectionTitle = financialDataDiv.querySelector('.section-title');
            
            // Mantener el título y limpiar solo los datos
            if (sectionTitle) {
                // En lugar de limpiar todo, preservamos el título y eliminamos solo los data-items existentes
                const existingItems = financialDataDiv.querySelectorAll('.data-item');
                existingItems.forEach(item => item.remove());
                
                // Asegurarnos de que el título permanezca en el contenedor
                financialDataDiv.innerHTML = '';
                financialDataDiv.appendChild(sectionTitle);
            } else {
                // Si no hay título, simplemente agregamos uno nuevo
                financialDataDiv.innerHTML = '<h3 class="section-title">Datos Financieros</h3>';
            }
            
            // Recrear el popup pero mantenerlo oculto
            const popupDiv = document.createElement('div');
            popupDiv.className = 'analysis-popup';
            popupDiv.style.display = 'none'; // Oculto desde el inicio
            popupDiv.innerHTML = `
                <div class="analysis-popup-content">
                    <div class="ai-animation"></div>
                    <h3>Analizando con IA RINO</h3>
                    <p>Extrayendo datos financieros...</p>
                </div>
            `;
            financialDataDiv.appendChild(popupDiv);

            // Crear un array de campos estándar para asegurarnos de que siempre se incluyan
            const camposEstandar = [
                "Prima neta", 
                "Gastos por expedición", 
                "I.V.A.", 
                "Precio total", 
                "Tasa de financiamiento", 
                "Prima mensual"
            ];
            
            // Campos específicos para pólizas de salud familiar
            const camposSaludFamiliar = [
                "Descuento familiar",
                "Cesión de Comisión",
                "Recargo por pago fraccionado",
                "Prima base I.V.A."
            ];
            
            // Determinar si estamos mostrando campos de una póliza de salud familiar
            const isSaludFamiliar = Object.keys(data).some(key => 
                camposSaludFamiliar.includes(key) && 
                data[key] && 
                data[key] !== "0" && 
                data[key] !== "0.00"
            );
            
            // Array final de campos a mostrar
            const camposAMostrar = [...camposEstandar];
            
            // Si es una póliza de salud familiar, agregar los campos específicos
            if (isSaludFamiliar) {
                camposAMostrar.push(...camposSaludFamiliar);
            }
            
            // Primero agregamos los campos estándar en el orden definido
            camposAMostrar.forEach(campo => {
                const valor = data[campo] || "0.00";
                
                // Crear el div para el item financiero
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-item');
                
                let displayValue = 'N/A';
                let verificationStatusHTML = '<span class="verification-status unverified"><i class="fas fa-times-circle"></i>Sin verificar</span>';
                
                // Formatear valor y estado de verificación
                if (campo === "Tasa de financiamiento") {
                    if (valor === null || valor === undefined || valor === "0.00") {
                        displayValue = '0.00%';
                    } else {
                        displayValue = parseFloat(valor).toFixed(2) + '%';
                        verificationStatusHTML = '<span class="verification-status auto-verified"><i class="fas fa-check-circle"></i>Verificado automáticamente</span>';
                    }
                } else {
                    const numericValue = parseFloat(String(valor).replace(',', ''));
                    if (!isNaN(numericValue)) {
                        displayValue = numericValue.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                        if (numericValue > 0) {
                            verificationStatusHTML = '<span class="verification-status auto-verified"><i class="fas fa-check-circle"></i>Verificado automáticamente</span>';
                        }
                    }
                }
                
                // Construir el HTML
                itemDiv.innerHTML = `
                    <div class="data-label">${campo}</div>
                    <div class="data-value">${displayValue}</div>
                    <div class="data-verification">
                        ${verificationStatusHTML}
                    </div>
                `;
                financialDataDiv.appendChild(itemDiv);
            });
            
            // Luego agregamos cualquier otro campo adicional que pueda venir en los datos
            for (const [key, value] of Object.entries(data)) {
                // Saltamos los que ya procesamos y los campos internos como ramo y tipo_endoso
                if (
                    camposEstandar.includes(key) || 
                    key === "ramo" || 
                    key === "tipo_endoso"
                ) {
                    continue;
                }
                
                // Crear el div para campos adicionales
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-item');
                
                let displayValue = 'N/A';
                let verificationStatusHTML = '<span class="verification-status unverified"><i class="fas fa-times-circle"></i>Sin verificar</span>';
                
                if (value !== null && value !== undefined) {
                    const numericValue = parseFloat(String(value).replace(',', ''));
                    if (!isNaN(numericValue)) {
                        displayValue = numericValue.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                        if (numericValue > 0) {
                            verificationStatusHTML = '<span class="verification-status auto-verified"><i class="fas fa-check-circle"></i>Verificado automáticamente</span>';
                        }
                    } else {
                        displayValue = value;
                    }
                }
                
                itemDiv.innerHTML = `
                    <div class="data-label">${key}</div>
                    <div class="data-value">${displayValue}</div>
                    <div class="data-verification">
                        ${verificationStatusHTML}
                    </div>
                `;
                financialDataDiv.appendChild(itemDiv);
            }
        }

        // Función para mostrar datos específicos de pólizas de vida
        function displayPolizaVidaData(data, container, replaceFinancialSection = false) {
            let polizaDataSection;
            
            if (replaceFinancialSection) {
                // Usar la sección financiera existente y cambiar su título
                polizaDataSection = container.querySelector('.pdf-data-section');
                if (polizaDataSection) {
                    polizaDataSection.innerHTML = '<h3 class="section-title">Datos Completos de la Póliza</h3>';
                }
            } else {
                // Crear o encontrar la sección para datos de póliza
                polizaDataSection = container.querySelector('.poliza-data-section');
                
                if (!polizaDataSection) {
                    // Si no existe, crear una nueva sección después de la sección financiera
                    const financialSection = container.querySelector('.pdf-data-section');
                    polizaDataSection = document.createElement('div');
                    polizaDataSection.className = 'pdf-data-section poliza-data-section mt-4';
                    polizaDataSection.innerHTML = '<h3 class="section-title">Datos de la Póliza</h3>';
                    
                    // Insertar después de la sección financiera
                    if (financialSection && financialSection.parentNode) {
                        financialSection.parentNode.insertBefore(polizaDataSection, financialSection.nextSibling);
                    } else {
                        // Si no se encuentra la sección financiera, añadir al final del contenedor
                        container.querySelector('.pdf-content').appendChild(polizaDataSection);
                    }
                } else {
                    // Si ya existe, limpiarla
                    polizaDataSection.innerHTML = '<h3 class="section-title">Datos de la Póliza</h3>';
                }
            }
            
            // Determinar si es una póliza de salud familiar por la presencia de campos específicos
            const isSaludFamiliar = data && (data["Descuento familiar"] || data["Cesión de Comisión"] || data["Recargo por pago fraccionado"]);
            
            // Si es una póliza de salud familiar, mostrar primero los campos prioritarios
            if (isSaludFamiliar) {
                console.log("Mostrando campos prioritarios para póliza de salud familiar");
                
                // Campos prioritarios para mostrar primero
                const camposPrioritarios = [
                    "Prima Neta",
                    "Prima anual total",
                    "I.V.A.",
                    "Prima base I.V.A.",
                    "Gastos de Expedición",
                    "Descuento familiar",
                    "Cesión de Comisión",
                    "Recargo por pago fraccionado",
                    "Derecho de póliza"
                ];
                
                // Mostrar campos prioritarios primero
                camposPrioritarios.forEach(campo => {
                    if (campo in data && data[campo] !== "0" && data[campo] !== "0.00") {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('data-item');
                        
                        let displayValue = data[campo];
                        
                        // Formatear valores monetarios
                        if (["Prima Neta", "Prima anual total", "I.V.A.", "Descuento familiar", "Cesión de Comisión", "Recargo por pago fraccionado", "Derecho de póliza"].includes(campo)) {
                            try {
                                const numericValue = parseFloat(String(displayValue).replace(',', ''));
                                if (!isNaN(numericValue)) {
                                    displayValue = numericValue.toLocaleString('es-MX', { 
                                        style: 'currency', 
                                        currency: 'MXN',
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2 
                                    });
                                }
                            } catch (e) {
                                console.log(`Error al formatear valor monetario: ${campo}=${data[campo]}`, e);
                            }
                        }
                        
                        const verificationStatus = '<span class="verification-status auto-verified"><i class="fas fa-check-circle"></i>Verificado automáticamente</span>';
                        
                        itemDiv.innerHTML = `
                            <div class="data-label">${campo}</div>
                            <div class="data-value">${displayValue}</div>
                            <div class="data-verification">
                                ${verificationStatus}
                            </div>
                        `;
                        
                        polizaDataSection.appendChild(itemDiv);
                    }
                });
            }
            
            // Mostrar todos los datos de la póliza sin filtrar
            for (const [key, value] of Object.entries(data)) {
                // Ignorar el campo de coberturas adicionales con costo y los campos ya mostrados en el caso de pólizas de salud familiar
                if (key === "Coberturas adicionales con costo" || 
                    (isSaludFamiliar && ["Prima Neta", "Prima anual total", "I.V.A.", "Descuento familiar", "Cesión de Comisión", "Recargo por pago fraccionado", "Derecho de póliza"].includes(key))) {
                    continue;
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-item');
                
                let displayValue = value === "0" ? "No disponible" : value;
                const isVerified = value !== "0";
                
                // Formatear valores monetarios correctamente
                if (isVerified && (
                    key === "Prima Neta" || 
                    key === "Prima anual total" || 
                    key === "Cobertura Básica" || 
                    key.includes("Prima") || 
                    key.includes("precio") || 
                    key.includes("Precio") || 
                    key.includes("costo") || 
                    key.includes("Costo")
                )) {
                    // Intenta convertir a número y formatear como moneda
                    try {
                        // Verificar si el valor ya tiene formato de moneda
                        if (typeof value === 'string') {
                            // Elimina cualquier caracter no numérico excepto punto y coma
                            const numValue = value.replace(/[^\d,.]/g, '');
                            // Reemplaza coma por punto para la conversión numérica si hay una coma como separador decimal
                            const normalizedValue = numValue.includes(',') && !numValue.includes('.') ? 
                                numValue.replace(',', '.') : numValue.replace(',', '');
                            
                            const parsedValue = parseFloat(normalizedValue);
                            
                            if (!isNaN(parsedValue)) {
                                displayValue = parsedValue.toLocaleString('es-MX', { 
                                    style: 'currency', 
                                    currency: 'MXN',
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2 
                                });
                            }
                        }
                    } catch (e) {
                        console.log(`Error al formatear valor monetario: ${key}=${value}`, e);
                        // Mantener el valor original si hay error
                    }
                }
                
                const verificationStatus = isVerified 
                    ? '<span class="verification-status auto-verified"><i class="fas fa-check-circle"></i>Verificado automáticamente</span>'
                    : '<span class="verification-status unverified"><i class="fas fa-times-circle"></i>Sin verificar</span>';
                
                itemDiv.innerHTML = `
                    <div class="data-label">${key}</div>
                    <div class="data-value">${displayValue}</div>
                    <div class="data-verification">
                        ${verificationStatus}
                    </div>
                `;
                
                polizaDataSection.appendChild(itemDiv);
            }
        }

        // Modal handling
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.preview-container')) {
                const img = e.target;
                const pdfData = img.getAttribute('data-pdf');
                const financialData = JSON.parse(img.getAttribute('data-financial') || '{}');
                
                // Determinar si es una póliza de vida o Aliados+ PPR
                const pdfItem = img.closest('.pdf-item');
                const tipoEndosoElement = pdfItem ? pdfItem.querySelector('.document-tipo-endoso') : null;
                const isPolizaVida = tipoEndosoElement && (tipoEndosoElement.textContent === "PÓLIZA DE VIDA" || 
                                                          tipoEndosoElement.textContent === "PÓLIZA ALIADOS+ PPR" ||
                                                          tipoEndosoElement.textContent === "PÓLIZA PROTGT TEMPORAL MN" ||
                                                          tipoEndosoElement.textContent === "PÓLIZA VIDA PROTGT");
                
                const isSaludFamiliar = tipoEndosoElement && (
                    tipoEndosoElement.textContent === "PÓLIZA DE GASTOS MÉDICOS MAYORES FAMILIAR" ||
                    tipoEndosoElement.textContent === "PÓLIZA DE GASTOS MÉDICOS MAYORES FAMILIAR (VARIANTE F)"
                );
                
                // Obtener datos de la póliza si aplica
                let polizaData = null;
                if ((isPolizaVida || isSaludFamiliar) && pdfItem && pdfItem.hasAttribute('data-poliza-data')) {
                    try {
                        polizaData = JSON.parse(pdfItem.getAttribute('data-poliza-data'));
                    } catch (e) {
                        console.error("Error al leer datos de póliza:", e);
                    }
                }
                
                // Actualizar el visor de PDF
                const modalPreview = document.getElementById('modal-preview');
                if (pdfData) {
                    const pdfUrl = `data:application/pdf;base64,${pdfData}`;
                    modalPreview.src = pdfUrl;
                    modalPreview.type = 'application/pdf';
                }
                
                // Actualizar los datos en el modal según el tipo de documento
                const modalTitle = document.querySelector('.modal-data-title');
                const modalData = document.querySelector('.modal-data-container');
                
                if (isPolizaVida) {
                    // Para pólizas de vida, mostrar todos los datos completos
                    if (modalTitle) modalTitle.textContent = "Datos Completos de la Póliza de Vida";
                    
                    // Limpiar el contenedor
                    if (modalData) {
                        modalData.innerHTML = '<h3 class="modal-data-title">Datos Completos de la Póliza de Vida</h3>';
                        
                        // Si tenemos datos directos de la póliza, los usamos primero
                        if (polizaData) {
                            console.log("Datos de póliza disponibles para modal:", polizaData);
                            for (const [key, value] of Object.entries(polizaData)) {
                                if (value === null || value === undefined || key === "Coberturas adicionales con costo") continue;
                                
                                let displayValue = value === "0" ? "No disponible" : value;
                                
                                // Formatear valores monetarios
                                if (value !== "0" && (
                                    key === "Prima Neta" || 
                                    key === "Prima anual total" || 
                                    key === "Cobertura Básica" || 
                                    key.includes("Prima") || 
                                    key.includes("precio") || 
                                    key.includes("Precio")
                                )) {
                                    try {
                                        console.log(`Modal: Intentando formatear valor monetario: ${key}=${value}`);
                                        
                                        // Verificar si el valor ya tiene formato de moneda
                                        if (typeof value === 'string') {
                                            // Elimina cualquier caracter no numérico excepto punto y coma
                                            const numValue = value.replace(/[^\d,.]/g, '');
                                            // Reemplaza coma por punto para la conversión numérica si hay una coma como separador decimal
                                            const normalizedValue = numValue.includes(',') && !numValue.includes('.') ? 
                                                numValue.replace(',', '.') : numValue.replace(',', '');
                                            
                                            console.log(`Modal: Valor normalizado: ${normalizedValue}`);
                                            const parsedValue = parseFloat(normalizedValue);
                                            
                                            if (!isNaN(parsedValue)) {
                                                displayValue = parsedValue.toLocaleString('es-MX', { 
                                                    style: 'currency', 
                                                    currency: 'MXN',
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2 
                                                });
                                                console.log(`Modal: Valor formateado: ${displayValue}`);
                                            }
                                        }
                                    } catch (e) {
                                        console.error(`Error al formatear valor monetario en modal: ${key}=${value}`, e);
                                    }
                                }
                                
                                console.log(`Modal: Añadiendo campo: ${key}=${displayValue}`);
                                
                                const dataItem = document.createElement('div');
                                dataItem.className = 'modal-data-item';
                                dataItem.innerHTML = `
                                    <div class="modal-data-label">${key}</div>
                                    <div class="modal-data-value">${displayValue}</div>
                                `;
                                modalData.appendChild(dataItem);
                            }
                        } else {
                            // Si no tenemos datos directos, intentamos clonar del DOM
                            const polizaDataSection = pdfItem ? pdfItem.querySelector('.pdf-data-section') : null;
                            if (polizaDataSection) {
                                const polizaItems = polizaDataSection.querySelectorAll('.data-item');
                                
                                polizaItems.forEach(item => {
                                    const clonedItem = document.createElement('div');
                                    clonedItem.className = 'modal-data-item';
                                    
                                    const label = item.querySelector('.data-label');
                                    const value = item.querySelector('.data-value');
                                    
                                    if (label && value) {
                                        clonedItem.innerHTML = `
                                            <div class="modal-data-label">${label.textContent}</div>
                                            <div class="modal-data-value">${value.textContent}</div>
                                        `;
                                        modalData.appendChild(clonedItem);
                                    }
                                });
                            }
                        }
                        
                        // Si no hay datos en el modal, mostrar mensaje
                        if (modalData.children.length <= 1) {
                            const noDataItem = document.createElement('div');
                            noDataItem.className = 'modal-data-item';
                            noDataItem.innerHTML = `
                                <div class="modal-data-label">Información</div>
                                <div class="modal-data-value">No hay datos disponibles para esta póliza</div>
                            `;
                            modalData.appendChild(noDataItem);
                        }
                    }
                } else if (isSaludFamiliar) {
                    // Para pólizas de salud familiar, mostrar los datos completos
                    if (modalTitle) modalTitle.textContent = "Datos Completos de la Póliza de Gastos Médicos";
                    
                    // Limpiar el contenedor
                    if (modalData) {
                        modalData.innerHTML = '<h3 class="modal-data-title">Datos Completos de la Póliza de Gastos Médicos</h3>';
                        
                        // Mostrar primero los campos financieros específicos de interés
                        const camposPrioritarios = [
                            "Prima Neta",
                            "Prima anual total",
                            "I.V.A.",
                            "Prima base I.V.A.",
                            "Gastos de Expedición",
                            "Descuento familiar",
                            "Cesión de Comisión",
                            "Recargo por pago fraccionado",
                            "Derecho de póliza"
                        ];
                        
                        // Si tenemos datos directos de la póliza
                        if (polizaData) {
                            console.log("Datos de póliza de salud familiar para modal:", polizaData);
                            
                            // Primero mostrar campos prioritarios
                            camposPrioritarios.forEach(campo => {
                                if (campo in polizaData && polizaData[campo] !== "0" && polizaData[campo] !== "0.00") {
                                    let valor = polizaData[campo];
                                    
                                    // Formatear valores numéricos
                                    try {
                                        const numVal = parseFloat(String(valor).replace(',', ''));
                                        if (!isNaN(numVal)) {
                                            valor = numVal.toLocaleString('es-MX', { 
                                                style: 'currency', 
                                                currency: 'MXN',
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2 
                                            });
                                        }
                                    } catch (e) {
                                        console.error(`Error al formatear ${campo}: ${valor}`, e);
                                    }
                                    
                                    const dataItem = document.createElement('div');
                                    dataItem.className = 'modal-data-item';
                                    dataItem.innerHTML = `
                                        <div class="modal-data-label">${campo}</div>
                                        <div class="modal-data-value">${valor}</div>
                                    `;
                                    modalData.appendChild(dataItem);
                                }
                            });
                            
                            // Luego agregar el resto de los campos
                            for (const [key, value] of Object.entries(polizaData)) {
                                // Saltar campos ya mostrados o nulos
                                if (value === null || value === undefined || 
                                    key === "Coberturas adicionales con costo" || 
                                    camposPrioritarios.includes(key)) continue;
                                
                                let displayValue = value === "0" ? "No disponible" : value;
                                
                                // Formatear valores monetarios si es necesario
                                if (value !== "0" && (
                                    key.includes("Prima") || key.includes("precio") || 
                                    key.includes("Precio") || key.includes("costo") || 
                                    key.includes("Costo") || key.includes("Suma")
                                )) {
                                    try {
                                        // Verificar si el valor ya tiene formato de moneda
                                        if (typeof value === 'string') {
                                            // Elimina cualquier caracter no numérico excepto punto y coma
                                            const numValue = value.replace(/[^\d,.]/g, '');
                                            if (numValue) {
                                                // Reemplaza coma por punto para la conversión numérica
                                                const normalizedValue = numValue.includes(',') && !numValue.includes('.') ? 
                                                    numValue.replace(',', '.') : numValue.replace(',', '');
                                                
                                                const parsedValue = parseFloat(normalizedValue);
                                                
                                                if (!isNaN(parsedValue)) {
                                                    displayValue = parsedValue.toLocaleString('es-MX', { 
                                                        style: 'currency', 
                                                        currency: 'MXN',
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2 
                                                    });
                                                }
                                            }
                                        }
                                    } catch (e) {
                                        console.error(`Error al formatear valor monetario en modal: ${key}=${value}`, e);
                                    }
                                }
                                
                                const dataItem = document.createElement('div');
                                dataItem.className = 'modal-data-item';
                                dataItem.innerHTML = `
                                    <div class="modal-data-label">${key}</div>
                                    <div class="modal-data-value">${displayValue}</div>
                                `;
                                modalData.appendChild(dataItem);
                            }
                        } else {
                            // Si no tenemos datos directos, clonar del DOM
                            const polizaDataSection = pdfItem ? pdfItem.querySelector('.pdf-data-section') : null;
                            if (polizaDataSection) {
                                const polizaItems = polizaDataSection.querySelectorAll('.data-item');
                                
                                polizaItems.forEach(item => {
                                    const clonedItem = document.createElement('div');
                                    clonedItem.className = 'modal-data-item';
                                    
                                    const label = item.querySelector('.data-label');
                                    const value = item.querySelector('.data-value');
                                    
                                    if (label && value) {
                                        clonedItem.innerHTML = `
                                            <div class="modal-data-label">${label.textContent}</div>
                                            <div class="modal-data-value">${value.textContent}</div>
                                        `;
                                        modalData.appendChild(clonedItem);
                                    }
                                });
                            }
                        }
                        
                        // Si no hay datos en el modal, mostrar mensaje
                        if (modalData.children.length <= 1) {
                            const noDataItem = document.createElement('div');
                            noDataItem.className = 'modal-data-item';
                            noDataItem.innerHTML = `
                                <div class="modal-data-label">Información</div>
                                <div class="modal-data-value">No hay datos disponibles para esta póliza</div>
                            `;
                            modalData.appendChild(noDataItem);
                        }
                    }
                } else {
                    // Para endosos tipo A, mostrar datos financieros normales
                    if (modalTitle) modalTitle.textContent = "Datos Financieros";
                    
                    // Actualizar los datos financieros en el modal
                    updateModalFinancialData(financialData);
                }
                
                modal.style.display = 'flex';
            }
        });

        function updateModalFinancialData(data) {
            const mappings = {
                'gastos': 'Gastos por expedición',
                'iva': 'I.V.A.',
                'total': 'Precio total',
                'prima': 'Prima neta',
                'tasa': 'Tasa de financiamiento',
                'descuento': 'Descuento familiar',
                'cesion': 'Cesión de Comisión',
                'recargo': 'Recargo por pago fraccionado',
                'prima_base_iva': 'Prima base I.V.A.'
            };

            // Limpiamos el contenedor de datos
            const modalData = document.querySelector('.modal-data-container');
            if (modalData) {
                modalData.innerHTML = '<h3 class="modal-data-title">Datos Financieros</h3>';
                
                // Campos estándar que siempre deberían mostrarse
                const standardFields = ['Prima neta', 'Gastos por expedición', 'I.V.A.', 'Precio total', 'Tasa de financiamiento'];
                
                // Campos específicos de pólizas de salud familiar
                const saludFamiliarFields = ['Descuento familiar', 'Cesión de Comisión', 'Recargo por pago fraccionado', 'Prima base I.V.A.'];
                
                // Determinar si estamos mostrando una póliza de salud familiar
                const hasSaludFamiliarFields = saludFamiliarFields.some(field => data[field] && data[field] !== '0' && data[field] !== '0.00');
                
                // Recreamos los elementos para los datos financieros
                Object.entries(mappings).forEach(([field, key]) => {
                    // Mostrar campos estándar o campos de salud familiar si corresponde
                    if (standardFields.includes(key) || (hasSaludFamiliarFields && saludFamiliarFields.includes(key) && data[key])) {
                        let valueToDisplay;
                        
                        if (field === 'tasa') {
                            valueToDisplay = data[key] || '0.00%';
                            if (!valueToDisplay.endsWith('%')) {
                                valueToDisplay = parseFloat(valueToDisplay).toFixed(2) + '%';
                            }
                        } else {
                            // Para valores numéricos, asegurar que se muestren en formato moneda
                            const valor = data[key] || '0.00';
                            try {
                                const numVal = parseFloat(String(valor).replace(',', ''));
                                if (!isNaN(numVal)) {
                                    valueToDisplay = numVal.toLocaleString('es-MX', { 
                                        style: 'currency', 
                                        currency: 'MXN',
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2 
                                    });
                                } else {
                                    valueToDisplay = '$0.00';
                                }
                            } catch (e) {
                                console.error(`Error al formatear ${key}: ${valor}`, e);
                                valueToDisplay = '$0.00';
                            }
                        }
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'modal-data-item';
                        itemDiv.innerHTML = `
                            <div class="modal-data-label">${key}</div>
                            <div class="modal-data-value" data-field="${field}">${valueToDisplay}</div>
                        `;
                        
                        modalData.appendChild(itemDiv);
                    }
                });
            }
        }

        modalClose.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Agregar soporte para zoom y navegación del PDF
        document.addEventListener('keydown', (e) => {
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') {
                    modal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html> 